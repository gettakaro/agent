<%- include('partials/header') %>

<div class="chat-page">
  <div class="chat-header">
    <div>
      <h1><%= conversation.title || 'Chat' %></h1>
      <div class="chat-meta">
        <span class="badge"><%= conversation.agentId %></span>
        <span class="badge badge-outline">v<%= conversation.agentVersion %></span>
        <span class="text-muted"><%= new Date(conversation.createdAt).toLocaleString() %></span>
      </div>
    </div>
    <a href="/conversations" class="btn btn-secondary">Back</a>
  </div>

  <div class="chat-messages" id="messages">
    <% if (messages.length === 0) { %>
      <div class="empty-state">
        <p>No messages yet. Start the conversation below.</p>
      </div>
    <% } else { %>
      <% messages.forEach(msg => { %>
        <div class="message message-<%= msg.role %>">
          <div class="message-header">
            <span class="message-role"><%= msg.role %></span>
          </div>
          <div class="message-content"><%= msg.content %></div>
        </div>
      <% }) %>
    <% } %>
  </div>

  <form class="chat-input" id="chatForm">
    <input type="hidden" name="conversationId" value="<%= conversation.id %>">
    <textarea
      name="content"
      id="messageInput"
      placeholder="Type your message..."
      rows="2"
      required
    ></textarea>
    <button type="submit" class="btn btn-primary">Send</button>
  </form>
</div>

<script>
  const form = document.getElementById('chatForm');
  const messagesContainer = document.getElementById('messages');
  const input = document.getElementById('messageInput');
  const conversationId = '<%= conversation.id %>';

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const content = input.value.trim();
    if (!content) return;

    // Add user message to UI
    addMessage('user', content);
    input.value = '';

    // Create assistant message placeholder
    const assistantMsg = addMessage('assistant', '');

    // Send to API with SSE
    const response = await fetch('/api/conversations/' + conversationId + '/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          try {
            const data = JSON.parse(line.slice(6));
            if (data.type === 'text') {
              assistantMsg.querySelector('.message-content').textContent += data.content;
            } else if (data.type === 'tool_use') {
              assistantMsg.querySelector('.message-content').textContent +=
                '\n[Using tool: ' + data.name + ']\n';
            } else if (data.type === 'error' || data.error) {
              assistantMsg.classList.add('message-error');
              assistantMsg.querySelector('.message-content').textContent =
                'Error: ' + (data.error || data.message || 'Unknown error');
            }
          } catch (e) {}
        } else if (line.startsWith('event: error')) {
          // Next data line will be the error
        }
      }
    }

    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  });

  function addMessage(role, content) {
    // Remove empty state if present
    const emptyState = messagesContainer.querySelector('.empty-state');
    if (emptyState) emptyState.remove();

    const div = document.createElement('div');
    div.className = 'message message-' + role;
    div.innerHTML =
      '<div class="message-header"><span class="message-role">' + role + '</span></div>' +
      '<div class="message-content">' + content + '</div>';
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    return div;
  }

  // Scroll to bottom on load
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
</script>

<%- include('partials/footer') %>
