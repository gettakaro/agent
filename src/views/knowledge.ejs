<%- include('partials/header') %>

<style>
  /* Override container for full-width layout */
  main.container {
    max-width: none;
    padding: 0;
    margin: 0;
    width: 100%;
  }
</style>

<div class="knowledge-layout">
  <!-- Mobile sidebar toggle -->
  <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
    <span class="hamburger-icon">&#9776;</span>
  </button>

  <!-- Overlay for mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar -->
  <aside class="knowledge-sidebar" id="knowledgeSidebar">
    <div class="sidebar-header">
      <h2>Knowledge Bases</h2>
    </div>
    <div class="kb-sidebar-list" id="kbList">
      <% if (knowledgeBases.length === 0) { %>
        <div class="empty-state">
          <p>No knowledge bases registered</p>
        </div>
      <% } else { %>
        <% knowledgeBases.forEach(kb => { %>
          <div
            class="kb-sidebar-item<%= selectedKb && selectedKb.id === kb.id ? ' active' : '' %>"
            data-id="<%= kb.id %>"
            onclick="selectKnowledgeBase('<%= kb.id %>')"
          >
            <span class="kb-sidebar-item-name"><%= kb.name %></span>
            <span class="kb-sidebar-item-count"><%= kb.documentCount %></span>
          </div>
        <% }) %>
      <% } %>
    </div>
  </aside>

  <!-- Main content area -->
  <main class="knowledge-main" id="knowledgeMain">
    <% if (!selectedKb) { %>
      <div class="empty-state" id="emptyState">
        <p>Select a knowledge base to view details</p>
      </div>
    <% } else { %>
      <div class="kb-detail" id="kbDetail">
        <div class="kb-detail-header">
          <div class="kb-detail-title">
            <span class="badge badge-outline"><%= selectedKb.version %></span>
            <h1><%= selectedKb.name %></h1>
          </div>
          <% if (selectedKb.source) { %>
            <button class="btn btn-primary" id="syncBtn" onclick="triggerSync('<%= selectedKb.id %>')">Sync Now</button>
          <% } %>
        </div>

        <p class="kb-description"><%= selectedKb.description %></p>

        <div class="kb-meta-grid">
          <div class="kb-meta-item">
            <span class="kb-meta-label">Documents</span>
            <span class="kb-meta-value"><%= selectedKb.documentCount.toLocaleString() %> chunks</span>
          </div>
          <div class="kb-meta-item">
            <span class="kb-meta-label">Last Sync</span>
            <span class="kb-meta-value" id="lastSync"><%= selectedKb.lastSyncedAt ? new Date(selectedKb.lastSyncedAt).toLocaleString() : 'Never' %></span>
          </div>
          <div class="kb-meta-item">
            <span class="kb-meta-label">Schedule</span>
            <span class="kb-meta-value"><%= selectedKb.refreshSchedule || 'Manual' %></span>
          </div>
          <div class="kb-meta-item">
            <span class="kb-meta-label">Source</span>
            <span class="kb-meta-value"><%= selectedKb.source ? 'GitHub' : 'Manual' %></span>
          </div>
        </div>

        <!-- Search Section -->
        <div class="kb-section">
          <div class="kb-section-header" onclick="toggleSection(this)">
            <span class="kb-section-icon">&#9660;</span>
            <h3>Search</h3>
          </div>
          <div class="kb-section-content">
            <div class="search-inline">
              <input type="text" id="searchQuery" class="form-control" placeholder="Search this knowledge base..." />
              <button class="btn btn-primary" onclick="executeSearch()">Search</button>
            </div>
            <div id="searchResults" class="search-results-inline"></div>
          </div>
        </div>

        <% if (selectedKb.source) { %>
        <!-- Source Configuration -->
        <div class="kb-section">
          <div class="kb-section-header" onclick="toggleSection(this)">
            <span class="kb-section-icon">&#9660;</span>
            <h3>Source Configuration</h3>
          </div>
          <div class="kb-section-content">
            <div class="source-config">
              <div class="source-config-item">
                <span class="source-config-label">GitHub URL</span>
                <span class="source-config-value"><a href="<%= selectedKb.source %>" target="_blank"><%= selectedKb.source.replace('https://github.com/', '') %></a></span>
              </div>
              <div class="source-config-item">
                <span class="source-config-label">Extensions</span>
                <span class="source-config-value"><%= selectedKb.extensions.join(', ') || '.md, .txt' %></span>
              </div>
              <div class="source-config-item">
                <span class="source-config-label">Chunk Size</span>
                <span class="source-config-value"><%= selectedKb.chunkSize %> chars (<%= selectedKb.chunkOverlap %> overlap)</span>
              </div>
              <% if (selectedKb.lastCommitSha) { %>
              <div class="source-config-item">
                <span class="source-config-label">Last Commit</span>
                <span class="source-config-value"><%= selectedKb.lastCommitSha.substring(0, 7) %></span>
              </div>
              <% } %>
            </div>
          </div>
        </div>
        <% } %>

        <!-- Agent Usage -->
        <div class="kb-section">
          <div class="kb-section-header" onclick="toggleSection(this)">
            <span class="kb-section-icon">&#9660;</span>
            <h3>Agent Usage (<%= agentUsage.length %>)</h3>
          </div>
          <div class="kb-section-content">
            <% if (agentUsage.length === 0) { %>
              <p class="text-muted">No agents currently use this knowledge base</p>
            <% } else { %>
              <div class="agent-usage-list">
                <% agentUsage.forEach(agentId => { %>
                  <a href="/agents?id=<%= agentId %>" class="agent-usage-item">
                    <span class="agent-usage-item-name"><%= agentId %></span>
                  </a>
                <% }) %>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    <% } %>
  </main>
</div>

<script>
  // Store all KB data for client-side navigation
  const kbData = <%- JSON.stringify(knowledgeBases) %>;
  let currentKbId = '<%= selectedKb ? selectedKb.id : "" %>';

  // Sidebar toggle for mobile
  const sidebarToggle = document.getElementById('sidebarToggle');
  const sidebar = document.getElementById('knowledgeSidebar');
  const overlay = document.getElementById('sidebarOverlay');

  function toggleSidebar() {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('open');
  }

  if (sidebarToggle) {
    sidebarToggle.addEventListener('click', toggleSidebar);
  }
  if (overlay) {
    overlay.addEventListener('click', toggleSidebar);
  }

  function toggleSection(header) {
    const section = header.closest('.kb-section');
    section.classList.toggle('collapsed');
    const icon = header.querySelector('.kb-section-icon');
    icon.innerHTML = section.classList.contains('collapsed') ? '&#9654;' : '&#9660;';
  }

  async function selectKnowledgeBase(id) {
    if (id === currentKbId) return;

    // Close mobile sidebar
    sidebar.classList.remove('open');
    overlay.classList.remove('open');

    // Update URL
    history.pushState({}, '', '/knowledge?id=' + encodeURIComponent(id));

    // Update active state in sidebar
    document.querySelectorAll('.kb-sidebar-item').forEach(item => {
      item.classList.toggle('active', item.dataset.id === id);
    });

    // Find KB data
    const kb = kbData.find(k => k.id === id);
    if (kb) {
      currentKbId = id;

      // Fetch agent usage for this KB
      let agents = [];
      try {
        const res = await fetch('/api/knowledge-bases/' + encodeURIComponent(id) + '/agents');
        const data = await res.json();
        agents = data.data || [];
      } catch (e) {
        console.error('Failed to fetch agent usage:', e);
      }

      renderKbDetail(kb, agents);
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatDate(dateStr) {
    if (!dateStr) return 'Never';
    return new Date(dateStr).toLocaleString();
  }

  function renderKbDetail(kb, agents = []) {
    const main = document.getElementById('knowledgeMain');

    const agentUsageHtml = agents.length > 0
      ? agents.map(agentId => `
          <a href="/agents?id=${encodeURIComponent(agentId)}" class="agent-usage-item">
            <span class="agent-usage-item-name">${escapeHtml(agentId)}</span>
          </a>
        `).join('')
      : '<p class="text-muted">No agents currently use this knowledge base</p>';

    const sourceConfigHtml = kb.source ? `
      <div class="kb-section">
        <div class="kb-section-header" onclick="toggleSection(this)">
          <span class="kb-section-icon">&#9660;</span>
          <h3>Source Configuration</h3>
        </div>
        <div class="kb-section-content">
          <div class="source-config">
            <div class="source-config-item">
              <span class="source-config-label">GitHub URL</span>
              <span class="source-config-value"><a href="${escapeHtml(kb.source)}" target="_blank">${escapeHtml(kb.source.replace('https://github.com/', ''))}</a></span>
            </div>
            <div class="source-config-item">
              <span class="source-config-label">Extensions</span>
              <span class="source-config-value">${escapeHtml((kb.extensions || []).join(', ') || '.md, .txt')}</span>
            </div>
            <div class="source-config-item">
              <span class="source-config-label">Chunk Size</span>
              <span class="source-config-value">${kb.chunkSize} chars (${kb.chunkOverlap} overlap)</span>
            </div>
            ${kb.lastCommitSha ? `
            <div class="source-config-item">
              <span class="source-config-label">Last Commit</span>
              <span class="source-config-value">${escapeHtml(kb.lastCommitSha.substring(0, 7))}</span>
            </div>
            ` : ''}
          </div>
        </div>
      </div>
    ` : '';

    const syncBtnHtml = kb.source
      ? `<button class="btn btn-primary" id="syncBtn" onclick="triggerSync('${escapeHtml(kb.id)}')">Sync Now</button>`
      : '';

    main.innerHTML = `
      <div class="kb-detail" id="kbDetail">
        <div class="kb-detail-header">
          <div class="kb-detail-title">
            <span class="badge badge-outline">${escapeHtml(kb.version)}</span>
            <h1>${escapeHtml(kb.name)}</h1>
          </div>
          ${syncBtnHtml}
        </div>

        <p class="kb-description">${escapeHtml(kb.description)}</p>

        <div class="kb-meta-grid">
          <div class="kb-meta-item">
            <span class="kb-meta-label">Documents</span>
            <span class="kb-meta-value">${kb.documentCount.toLocaleString()} chunks</span>
          </div>
          <div class="kb-meta-item">
            <span class="kb-meta-label">Last Sync</span>
            <span class="kb-meta-value" id="lastSync">${formatDate(kb.lastSyncedAt)}</span>
          </div>
          <div class="kb-meta-item">
            <span class="kb-meta-label">Schedule</span>
            <span class="kb-meta-value">${escapeHtml(kb.refreshSchedule || 'Manual')}</span>
          </div>
          <div class="kb-meta-item">
            <span class="kb-meta-label">Source</span>
            <span class="kb-meta-value">${kb.source ? 'GitHub' : 'Manual'}</span>
          </div>
        </div>

        <div class="kb-section">
          <div class="kb-section-header" onclick="toggleSection(this)">
            <span class="kb-section-icon">&#9660;</span>
            <h3>Search</h3>
          </div>
          <div class="kb-section-content">
            <div class="search-inline">
              <input type="text" id="searchQuery" class="form-control" placeholder="Search this knowledge base..." />
              <button class="btn btn-primary" onclick="executeSearch()">Search</button>
            </div>
            <div id="searchResults" class="search-results-inline"></div>
          </div>
        </div>

        ${sourceConfigHtml}

        <div class="kb-section">
          <div class="kb-section-header" onclick="toggleSection(this)">
            <span class="kb-section-icon">&#9660;</span>
            <h3>Agent Usage (${agents.length})</h3>
          </div>
          <div class="kb-section-content">
            <div class="agent-usage-list">${agentUsageHtml}</div>
          </div>
        </div>
      </div>
    `;
  }

  async function executeSearch() {
    const query = document.getElementById('searchQuery').value.trim();
    if (!query || !currentKbId) return;

    const resultsContainer = document.getElementById('searchResults');
    resultsContainer.innerHTML = '<div class="text-muted">Searching...</div>';

    try {
      const response = await fetch(`/api/knowledge-bases/${encodeURIComponent(currentKbId)}/search?q=${encodeURIComponent(query)}&limit=10`);
      if (!response.ok) throw new Error('Search failed');
      const result = await response.json();
      const results = result.data || [];

      if (results.length === 0) {
        resultsContainer.innerHTML = '<div class="text-muted">No results found.</div>';
        return;
      }

      resultsContainer.innerHTML = results.map(r => `
        <div class="search-result-inline">
          <div class="search-result-header">
            <span class="search-result-source">${escapeHtml(r.metadata?.sourceFile || 'Unknown source')}</span>
            <span class="search-result-score">${(r.score * 100).toFixed(1)}%</span>
          </div>
          <div class="search-result-content">${escapeHtml(r.content)}</div>
        </div>
      `).join('');
    } catch (err) {
      resultsContainer.innerHTML = '<div class="text-muted">Search failed.</div>';
      console.error('Search error:', err);
    }
  }

  async function triggerSync(kbId) {
    const syncBtn = document.getElementById('syncBtn');
    if (syncBtn) {
      syncBtn.disabled = true;
      syncBtn.classList.add('syncing');
      syncBtn.textContent = 'Syncing...';
    }

    try {
      const response = await fetch(`/api/knowledge-bases/${encodeURIComponent(kbId)}/sync`, { method: 'POST' });
      if (!response.ok) throw new Error('Sync failed');
      const result = await response.json();
      alert(`Sync job queued (ID: ${result.data.jobId})`);

      // Reload page after short delay to show updated status
      setTimeout(() => {
        window.location.reload();
      }, 2000);
    } catch (err) {
      alert('Failed to trigger sync');
      console.error('Sync error:', err);
      if (syncBtn) {
        syncBtn.disabled = false;
        syncBtn.classList.remove('syncing');
        syncBtn.textContent = 'Sync Now';
      }
    }
  }

  // Handle Enter key in search input
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && document.activeElement?.id === 'searchQuery') {
      executeSearch();
    }
  });

  // Handle browser back/forward
  window.addEventListener('popstate', () => {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    if (id && id !== currentKbId) {
      selectKnowledgeBase(id);
    } else if (!id && currentKbId) {
      // Deselect
      currentKbId = '';
      document.querySelectorAll('.kb-sidebar-item').forEach(item => {
        item.classList.remove('active');
      });
      document.getElementById('knowledgeMain').innerHTML = `
        <div class="empty-state" id="emptyState">
          <p>Select a knowledge base to view details</p>
        </div>
      `;
    }
  });
</script>

<%- include('partials/footer') %>
