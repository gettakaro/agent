<%- include('partials/header') %>

<div class="page">
  <div class="page-header">
    <h1>Knowledge Bases</h1>
  </div>

  <div id="flash-message" class="alert" style="display: none;"></div>

  <div id="kb-list" class="card-grid">
    <div class="loading">Loading knowledge bases...</div>
  </div>

  <!-- Search Modal -->
  <div id="search-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="search-modal-title">Search Knowledge Base</h2>
        <button class="btn-close" onclick="closeSearchModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <input type="text" id="search-query" class="form-control" placeholder="Enter search query..." />
          <button class="btn btn-primary" onclick="executeSearch()">Search</button>
        </div>
        <div id="search-results" class="search-results"></div>
      </div>
    </div>
  </div>
</div>

<style>
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 1.5rem;
  }

  .kb-card {
    background: var(--card-bg, #1a1a2e);
    border: 1px solid var(--border-color, #2a2a4e);
    border-radius: 8px;
    padding: 1.5rem;
  }

  .kb-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
  }

  .kb-card-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
  }

  .kb-card-description {
    color: var(--text-muted, #888);
    font-size: 0.875rem;
    margin: 0.5rem 0 1rem;
  }

  .kb-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-bottom: 1rem;
    font-size: 0.875rem;
  }

  .kb-stat {
    display: flex;
    flex-direction: column;
  }

  .kb-stat-label {
    color: var(--text-muted, #888);
    font-size: 0.75rem;
    text-transform: uppercase;
  }

  .kb-stat-value {
    font-weight: 500;
  }

  .kb-actions {
    display: flex;
    gap: 0.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color, #2a2a4e);
  }

  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal-content {
    background: var(--card-bg, #1a1a2e);
    border: 1px solid var(--border-color, #2a2a4e);
    border-radius: 8px;
    width: 90%;
    max-width: 700px;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border-color, #2a2a4e);
  }

  .modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
  }

  .btn-close {
    background: none;
    border: none;
    color: var(--text-muted, #888);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    line-height: 1;
  }

  .btn-close:hover {
    color: var(--text-color, #fff);
  }

  .modal-body {
    padding: 1.5rem;
    overflow-y: auto;
  }

  .modal-body .form-group {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .modal-body .form-control {
    flex: 1;
  }

  .search-results {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .search-result {
    background: var(--bg-secondary, #0f0f1a);
    border: 1px solid var(--border-color, #2a2a4e);
    border-radius: 6px;
    padding: 1rem;
  }

  .search-result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .search-result-score {
    font-size: 0.75rem;
    color: var(--text-muted, #888);
    background: var(--bg-tertiary, #1a1a2e);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }

  .search-result-source {
    font-size: 0.75rem;
    color: var(--text-muted, #888);
  }

  .search-result-content {
    font-size: 0.875rem;
    line-height: 1.5;
    white-space: pre-wrap;
    max-height: 150px;
    overflow-y: auto;
  }

  .loading, .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-muted, #888);
  }

  .syncing {
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
</style>

<script>
  let knowledgeBases = [];
  let currentSearchKbId = null;

  function showFlash(message, type) {
    const flash = document.getElementById('flash-message');
    flash.textContent = message;
    flash.className = 'alert alert-' + type;
    flash.style.display = 'block';
    setTimeout(() => { flash.style.display = 'none'; }, 5000);
  }

  function formatDate(dateStr) {
    if (!dateStr) return 'Never';
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
  }

  function formatNumber(num) {
    if (num >= 1000) {
      return (num / 1000).toFixed(1) + 'k';
    }
    return num.toString();
  }

  function renderKnowledgeBases() {
    const container = document.getElementById('kb-list');

    if (knowledgeBases.length === 0) {
      container.innerHTML = '<div class="empty-state">No knowledge bases configured.</div>';
      return;
    }

    container.innerHTML = knowledgeBases.map(kb => `
      <div class="kb-card" data-kb-id="${kb.id}">
        <div class="kb-card-header">
          <h3 class="kb-card-title">${kb.name}</h3>
          <span class="badge badge-outline">${kb.version}</span>
        </div>
        ${kb.description ? `<p class="kb-card-description">${kb.description}</p>` : ''}
        <div class="kb-stats">
          <div class="kb-stat">
            <span class="kb-stat-label">Documents</span>
            <span class="kb-stat-value">${formatNumber(kb.documentCount)} chunks</span>
          </div>
          <div class="kb-stat">
            <span class="kb-stat-label">Last Sync</span>
            <span class="kb-stat-value">${formatDate(kb.lastSyncedAt)}</span>
          </div>
          <div class="kb-stat">
            <span class="kb-stat-label">Source</span>
            <span class="kb-stat-value">${kb.source ? 'GitHub' : 'Manual'}</span>
          </div>
          <div class="kb-stat">
            <span class="kb-stat-label">Schedule</span>
            <span class="kb-stat-value">${kb.refreshSchedule || 'None'}</span>
          </div>
        </div>
        <div class="kb-actions">
          <button class="btn btn-secondary" onclick="openSearchModal('${kb.id}', '${kb.name}')">Search</button>
          ${kb.source ? `<button class="btn btn-secondary" onclick="triggerSync('${kb.id}')">Sync Now</button>` : ''}
        </div>
      </div>
    `).join('');
  }

  async function loadKnowledgeBases() {
    try {
      const response = await fetch('/api/knowledge-bases');
      if (!response.ok) throw new Error('Failed to load');
      const result = await response.json();
      knowledgeBases = result.data || [];
      renderKnowledgeBases();
    } catch (err) {
      document.getElementById('kb-list').innerHTML =
        '<div class="empty-state">Failed to load knowledge bases.</div>';
      showFlash('Failed to load knowledge bases', 'error');
    }
  }

  function openSearchModal(kbId, kbName) {
    currentSearchKbId = kbId;
    document.getElementById('search-modal-title').textContent = `Search: ${kbName}`;
    document.getElementById('search-query').value = '';
    document.getElementById('search-results').innerHTML = '';
    document.getElementById('search-modal').style.display = 'flex';
    document.getElementById('search-query').focus();
  }

  function closeSearchModal() {
    document.getElementById('search-modal').style.display = 'none';
    currentSearchKbId = null;
  }

  async function executeSearch() {
    const query = document.getElementById('search-query').value.trim();
    if (!query || !currentSearchKbId) return;

    const resultsContainer = document.getElementById('search-results');
    resultsContainer.innerHTML = '<div class="loading">Searching...</div>';

    try {
      const response = await fetch(`/api/knowledge-bases/${currentSearchKbId}/search?q=${encodeURIComponent(query)}&limit=10`);
      if (!response.ok) throw new Error('Search failed');
      const result = await response.json();
      const results = result.data || [];

      if (results.length === 0) {
        resultsContainer.innerHTML = '<div class="empty-state">No results found.</div>';
        return;
      }

      resultsContainer.innerHTML = results.map((r, i) => `
        <div class="search-result">
          <div class="search-result-header">
            <span class="search-result-source">${r.metadata?.sourceFile || 'Unknown source'}</span>
            <span class="search-result-score">Score: ${(r.score * 100).toFixed(1)}%</span>
          </div>
          <div class="search-result-content">${escapeHtml(r.content)}</div>
        </div>
      `).join('');
    } catch (err) {
      resultsContainer.innerHTML = '<div class="empty-state">Search failed.</div>';
      showFlash('Search failed', 'error');
    }
  }

  async function triggerSync(kbId) {
    const card = document.querySelector(`[data-kb-id="${kbId}"]`);
    const syncBtn = card?.querySelector('button:last-child');
    if (syncBtn) {
      syncBtn.disabled = true;
      syncBtn.classList.add('syncing');
      syncBtn.textContent = 'Syncing...';
    }

    try {
      const response = await fetch(`/api/knowledge-bases/${kbId}/sync`, { method: 'POST' });
      if (!response.ok) throw new Error('Sync failed');
      const result = await response.json();
      showFlash(`Sync job queued (ID: ${result.data.jobId})`, 'success');

      // Reload after short delay to show updated status
      setTimeout(loadKnowledgeBases, 2000);
    } catch (err) {
      showFlash('Failed to trigger sync', 'error');
      if (syncBtn) {
        syncBtn.disabled = false;
        syncBtn.classList.remove('syncing');
        syncBtn.textContent = 'Sync Now';
      }
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Handle Enter key in search input
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && document.activeElement?.id === 'search-query') {
      executeSearch();
    }
    if (e.key === 'Escape' && document.getElementById('search-modal').style.display === 'flex') {
      closeSearchModal();
    }
  });

  // Initial load
  loadKnowledgeBases();
</script>

<%- include('partials/footer') %>
