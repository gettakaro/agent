<%- include('partials/header') %>

<style>
  /* Override container for full-width layout */
  main.container {
    max-width: none;
    padding: 0;
    margin: 0;
    width: 100%;
  }

  /* Tab styles */
  .agents-tabs {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    padding: 0 1rem;
    background: var(--bg-secondary);
  }

  .agents-tab {
    padding: 0.75rem 1.5rem;
    border: none;
    background: none;
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    font-size: 0.9rem;
  }

  .agents-tab:hover {
    color: var(--text-primary);
  }

  .agents-tab.active {
    color: var(--text-primary);
    border-bottom-color: var(--accent-primary);
  }

  /* Custom agent form styles */
  .agent-form {
    padding: 1.5rem;
    max-width: 900px;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .form-group {
    margin-bottom: 1.25rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-secondary);
  }

  .form-control {
    width: 100%;
    padding: 0.625rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    color: var(--text-primary);
    font-size: 0.9rem;
  }

  .form-control:focus {
    outline: none;
    border-color: var(--accent-primary);
  }

  .system-prompt-editor {
    font-family: 'JetBrains Mono', monospace;
    min-height: 250px;
    resize: vertical;
    line-height: 1.5;
  }

  /* Tool selection grid */
  .tool-category-header {
    font-weight: 600;
    color: var(--text-muted);
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .tool-category-header:first-child {
    margin-top: 0;
  }

  .tool-selection-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 0.5rem;
  }

  .tool-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .tool-checkbox:hover {
    background: var(--bg-hover);
  }

  .tool-checkbox.selected {
    border-color: var(--accent-primary);
    background: rgba(88, 166, 255, 0.1);
  }

  .tool-checkbox input {
    margin: 0;
  }

  .tool-checkbox span {
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* KB selection */
  .kb-selection {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .kb-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .kb-checkbox:hover {
    background: var(--bg-hover);
  }

  .kb-checkbox.selected {
    border-color: var(--accent-primary);
    background: rgba(88, 166, 255, 0.1);
  }

  /* Form actions */
  .form-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
  }

  .btn-danger {
    background: var(--accent-danger);
    color: white;
  }

  .btn-danger:hover {
    background: #da3633;
  }

  /* Custom agent list item */
  .custom-agent-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.625rem 0.75rem;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.15s ease;
  }

  .custom-agent-item:hover {
    background: var(--bg-hover);
  }

  .custom-agent-item.active {
    background: var(--bg-tertiary);
    border-left: 2px solid var(--accent-primary);
  }

  .custom-agent-name {
    font-weight: 500;
    color: var(--text-primary);
  }

  .custom-agent-model {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  /* Create button in sidebar */
  .sidebar-actions {
    padding: 0.75rem;
    border-bottom: 1px solid var(--border-color);
  }

  /* Model custom input */
  .model-custom-input {
    margin-top: 0.5rem;
  }

  .model-custom-input.hidden {
    display: none;
  }

  /* Agent detail actions (for custom agent view mode) */
  .agent-detail-actions {
    display: flex;
    gap: 0.5rem;
  }
</style>

<div class="agents-layout">
  <!-- Mobile sidebar toggle -->
  <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
    <span class="hamburger-icon">&#9776;</span>
  </button>

  <!-- Overlay for mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar -->
  <aside class="agents-sidebar" id="agentsSidebar">
    <div class="sidebar-header">
      <h2>Agents</h2>
    </div>

    <!-- Tabs -->
    <div class="agents-tabs">
      <button class="agents-tab<%= tab === 'builtin' ? ' active' : '' %>" onclick="switchTab('builtin')">Built-in</button>
      <button class="agents-tab<%= tab === 'custom' ? ' active' : '' %>" onclick="switchTab('custom')">Custom</button>
    </div>

    <!-- Built-in agents list -->
    <div class="agent-groups" id="builtinAgents" style="<%= tab === 'custom' ? 'display: none;' : '' %>">
      <% if (groupedAgents.length === 0) { %>
        <div class="empty-state">
          <p>No agents registered</p>
        </div>
      <% } else { %>
        <% groupedAgents.forEach(group => { %>
          <div class="agent-group" data-type="<%= group.type %>">
            <div class="agent-group-header" onclick="toggleGroup(this)">
              <span class="agent-group-icon">&#9660;</span>
              <span class="agent-group-name"><%= group.type %></span>
              <span class="agent-group-count"><%= group.experiments.length %></span>
            </div>
            <div class="agent-group-items">
              <% group.experiments.forEach(exp => { %>
                <div
                  class="agent-item<%= selectedAgent && selectedAgent.id === exp.id ? ' active' : '' %>"
                  data-id="<%= exp.id %>"
                  onclick="selectAgent('<%= exp.id %>')"
                >
                  <span class="agent-item-name"><%= exp.experiment %></span>
                </div>
              <% }) %>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>

    <!-- Custom agents list -->
    <div class="agent-groups" id="customAgents" style="<%= tab === 'builtin' ? 'display: none;' : '' %>">
      <div class="sidebar-actions">
        <button class="btn btn-primary btn-small" style="width: 100%;" onclick="createNewAgent()">+ Create Agent</button>
      </div>
      <% if (customAgents.length === 0) { %>
        <div class="empty-state" style="padding: 1rem;">
          <p>No custom agents yet</p>
        </div>
      <% } else { %>
        <% customAgents.forEach(agent => { %>
          <div
            class="custom-agent-item<%= selectedCustomAgent && selectedCustomAgent.id === agent.id ? ' active' : '' %>"
            data-id="<%= agent.id %>"
            onclick="selectCustomAgent('<%= agent.id %>')"
          >
            <div>
              <div class="custom-agent-name"><%= agent.name %></div>
              <div class="custom-agent-model"><%= agent.model.split('/').pop() %></div>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </aside>

  <!-- Main content area -->
  <main class="agents-main" id="agentsMain">
    <% if (tab === 'builtin' && !selectedAgent) { %>
      <div class="empty-state" id="emptyState">
        <p>Select an agent to view details</p>
      </div>
    <% } else if (tab === 'builtin' && selectedAgent) { %>
      <!-- Built-in agent detail view -->
      <div class="agent-detail" id="agentDetail">
        <div class="agent-detail-header">
          <div class="agent-detail-title">
            <span class="agent-type-badge"><%= selectedAgent.type %></span>
            <h1><%= selectedAgent.experiment %></h1>
          </div>
          <a href="/new?agent=<%= selectedAgent.id %>" class="btn btn-primary">Start Chat</a>
        </div>

        <p class="agent-description"><%= selectedAgent.description %></p>

        <div class="agent-meta-grid">
          <div class="agent-meta-item">
            <span class="agent-meta-label">Model</span>
            <span class="agent-meta-value"><%= selectedAgent.model %></span>
          </div>
          <% if (selectedAgent.temperature !== undefined) { %>
          <div class="agent-meta-item">
            <span class="agent-meta-label">Temperature</span>
            <span class="agent-meta-value"><%= selectedAgent.temperature %></span>
          </div>
          <% } %>
          <% if (selectedAgent.maxTokens !== undefined) { %>
          <div class="agent-meta-item">
            <span class="agent-meta-label">Max Tokens</span>
            <span class="agent-meta-value"><%= selectedAgent.maxTokens.toLocaleString() %></span>
          </div>
          <% } %>
          <div class="agent-meta-item">
            <span class="agent-meta-label">Tools</span>
            <span class="agent-meta-value"><%= selectedAgent.toolCount %></span>
          </div>
        </div>

        <!-- Recent Conversations -->
        <div class="agent-section">
          <div class="agent-section-header" onclick="toggleSection(this)">
            <span class="agent-section-icon">&#9660;</span>
            <h3>Recent Conversations (<%= recentConversations.length %>)</h3>
          </div>
          <div class="agent-section-content">
            <% if (recentConversations.length === 0) { %>
              <p class="text-muted">No conversations yet</p>
            <% } else { %>
              <div class="conversation-list-compact">
                <% recentConversations.forEach(conv => { %>
                  <a href="/?id=<%= conv.id %>" class="conversation-item-compact">
                    <span class="conversation-title"><%= conv.title || 'Untitled conversation' %></span>
                    <span class="conversation-date"><%= conv.updatedAt.toLocaleDateString() %></span>
                  </a>
                <% }) %>
              </div>
            <% } %>
          </div>
        </div>

        <% if (selectedAgent.knowledgeBases.length > 0) { %>
        <!-- Knowledge Bases -->
        <div class="agent-section">
          <div class="agent-section-header" onclick="toggleSection(this)">
            <span class="agent-section-icon">&#9660;</span>
            <h3>Knowledge Bases (<%= selectedAgent.knowledgeBases.length %>)</h3>
          </div>
          <div class="agent-section-content">
            <div class="kb-list">
              <% selectedAgent.knowledgeBases.forEach(kb => { %>
                <span class="badge badge-outline"><%= kb %></span>
              <% }) %>
            </div>
          </div>
        </div>
        <% } %>

        <!-- Available Tools -->
        <div class="agent-section">
          <div class="agent-section-header" onclick="toggleSection(this)">
            <span class="agent-section-icon">&#9660;</span>
            <h3>Available Tools (<%= selectedAgent.tools.length %>)</h3>
          </div>
          <div class="agent-section-content">
            <div class="tools-grid">
              <% selectedAgent.tools.forEach(tool => { %>
                <div class="tool-card">
                  <div class="tool-card-name"><%= tool.name %></div>
                  <div class="tool-card-description"><%= tool.description %></div>
                </div>
              <% }) %>
            </div>
          </div>
        </div>

        <!-- System Prompt -->
        <div class="agent-section">
          <div class="agent-section-header" onclick="toggleSection(this)">
            <span class="agent-section-icon">&#9660;</span>
            <h3>System Prompt</h3>
          </div>
          <div class="agent-section-content">
            <div class="system-prompt-container">
              <pre class="system-prompt-preview" id="promptPreview"><%= selectedAgent.systemPromptPreview %></pre>
              <pre class="system-prompt-full hidden" id="promptFull"><%= selectedAgent.systemPromptFull %></pre>
            </div>
            <button class="btn btn-small btn-secondary" onclick="toggleSystemPrompt(event)" style="margin-top: 0.5rem;">
              <span id="togglePromptText">Show Full</span>
            </button>
          </div>
        </div>
      </div>
    <% } else if (tab === 'custom' && !selectedCustomAgent) { %>
      <!-- Custom agent empty state / create form -->
      <div class="empty-state" id="emptyState">
        <h2>Custom Agents</h2>
        <p>Create your own agent with a custom system prompt and selected tools.</p>
        <button class="btn btn-primary" onclick="createNewAgent()">Create Agent</button>
      </div>
    <% } else if (tab === 'custom' && selectedCustomAgent && !editMode) { %>
      <!-- Custom agent view mode -->
      <div class="agent-detail" id="agentDetail">
        <div class="agent-detail-header">
          <div class="agent-detail-title">
            <span class="agent-type-badge">Custom</span>
            <h1><%= selectedCustomAgent.name %></h1>
          </div>
          <div class="agent-detail-actions">
            <button class="btn btn-secondary" onclick="editCustomAgent()">Edit</button>
            <button class="btn btn-primary" onclick="startChatWithCustomAgent('<%= selectedCustomAgent.id %>')">Start Chat</button>
          </div>
        </div>

        <p class="agent-description"><%= selectedCustomAgent.description || 'No description' %></p>

        <div class="agent-meta-grid">
          <div class="agent-meta-item">
            <span class="agent-meta-label">Model</span>
            <span class="agent-meta-value"><%= selectedCustomAgent.model %></span>
          </div>
          <div class="agent-meta-item">
            <span class="agent-meta-label">Temperature</span>
            <span class="agent-meta-value"><%= selectedCustomAgent.temperature %></span>
          </div>
          <div class="agent-meta-item">
            <span class="agent-meta-label">Max Tokens</span>
            <span class="agent-meta-value"><%= selectedCustomAgent.maxTokens.toLocaleString() %></span>
          </div>
          <div class="agent-meta-item">
            <span class="agent-meta-label">Tools</span>
            <span class="agent-meta-value"><%= selectedCustomAgent.tools.length %></span>
          </div>
        </div>

        <!-- Recent Conversations -->
        <div class="agent-section">
          <div class="agent-section-header" onclick="toggleSection(this)">
            <span class="agent-section-icon">&#9660;</span>
            <h3>Recent Conversations (<%= recentConversations.length %>)</h3>
          </div>
          <div class="agent-section-content">
            <% if (recentConversations.length === 0) { %>
              <p class="text-muted">No conversations yet</p>
            <% } else { %>
              <div class="conversation-list-compact">
                <% recentConversations.forEach(conv => { %>
                  <a href="/?id=<%= conv.id %>" class="conversation-item-compact">
                    <span class="conversation-title"><%= conv.title || 'Untitled conversation' %></span>
                    <span class="conversation-date"><%= conv.updatedAt.toLocaleDateString() %></span>
                  </a>
                <% }) %>
              </div>
            <% } %>
          </div>
        </div>

        <% if (selectedCustomAgent.knowledgeBases.length > 0) { %>
        <!-- Knowledge Bases -->
        <div class="agent-section">
          <div class="agent-section-header" onclick="toggleSection(this)">
            <span class="agent-section-icon">&#9660;</span>
            <h3>Knowledge Bases (<%= selectedCustomAgent.knowledgeBases.length %>)</h3>
          </div>
          <div class="agent-section-content">
            <div class="kb-list">
              <% selectedCustomAgent.knowledgeBases.forEach(kb => { %>
                <span class="badge badge-outline"><%= kb %></span>
              <% }) %>
            </div>
          </div>
        </div>
        <% } %>

        <!-- Available Tools -->
        <div class="agent-section">
          <div class="agent-section-header" onclick="toggleSection(this)">
            <span class="agent-section-icon">&#9660;</span>
            <h3>Available Tools (<%= selectedCustomAgent.tools.length %>)</h3>
          </div>
          <div class="agent-section-content">
            <div class="tools-grid">
              <%
                const selectedToolNames = selectedCustomAgent.tools;
                const toolsWithDescriptions = availableTools.filter(t => selectedToolNames.includes(t.name));
              %>
              <% toolsWithDescriptions.forEach(tool => { %>
                <div class="tool-card">
                  <div class="tool-card-name"><%= tool.name %></div>
                  <div class="tool-card-description"><%= tool.description %></div>
                </div>
              <% }) %>
            </div>
          </div>
        </div>

        <!-- System Prompt -->
        <div class="agent-section">
          <div class="agent-section-header" onclick="toggleSection(this)">
            <span class="agent-section-icon">&#9660;</span>
            <h3>System Prompt</h3>
          </div>
          <div class="agent-section-content">
            <%
              const promptPreview = selectedCustomAgent.systemPrompt.substring(0, 500) + (selectedCustomAgent.systemPrompt.length > 500 ? '...' : '');
            %>
            <div class="system-prompt-container">
              <pre class="system-prompt-preview" id="promptPreview"><%= promptPreview %></pre>
              <pre class="system-prompt-full hidden" id="promptFull"><%= selectedCustomAgent.systemPrompt %></pre>
            </div>
            <button class="btn btn-small btn-secondary" onclick="toggleSystemPrompt(event)" style="margin-top: 0.5rem;">
              <span id="togglePromptText">Show Full</span>
            </button>
          </div>
        </div>
      </div>
    <% } else if (tab === 'custom' && selectedCustomAgent && editMode) { %>
      <!-- Custom agent editor -->
      <form class="agent-form" id="agentForm" onsubmit="saveAgent(event)">
        <input type="hidden" id="agentId" value="<%= selectedCustomAgent.id %>">

        <div class="form-group">
          <label for="name">Name</label>
          <input type="text" id="name" class="form-control" value="<%= selectedCustomAgent.name %>" required maxlength="100">
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" class="form-control" rows="2"><%= selectedCustomAgent.description || '' %></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="model">Model</label>
            <select id="model" class="form-control" onchange="toggleCustomModel()">
              <% availableModels.forEach(m => { %>
                <option value="<%= m.id %>" <%= selectedCustomAgent.model === m.id ? 'selected' : '' %>><%= m.name %></option>
              <% }) %>
              <option value="custom" <%= !availableModels.some(m => m.id === selectedCustomAgent.model) ? 'selected' : '' %>>Custom...</option>
            </select>
            <input type="text" id="customModel" class="form-control model-custom-input<%= availableModels.some(m => m.id === selectedCustomAgent.model) ? ' hidden' : '' %>" placeholder="Enter OpenRouter model ID" value="<%= !availableModels.some(m => m.id === selectedCustomAgent.model) ? selectedCustomAgent.model : '' %>">
          </div>
          <div class="form-group">
            <label for="temperature">Temperature</label>
            <input type="number" id="temperature" class="form-control" value="<%= selectedCustomAgent.temperature %>" min="0" max="2" step="0.1">
          </div>
          <div class="form-group">
            <label for="maxTokens">Max Tokens</label>
            <input type="number" id="maxTokens" class="form-control" value="<%= selectedCustomAgent.maxTokens %>" min="100" max="128000">
          </div>
        </div>

        <div class="form-group">
          <label for="systemPrompt">System Prompt</label>
          <textarea id="systemPrompt" class="form-control system-prompt-editor" required><%= selectedCustomAgent.systemPrompt %></textarea>
        </div>

        <div class="form-group">
          <label>Tools (<span id="toolCount"><%= selectedCustomAgent.tools.length %></span> selected)</label>
          <%
            const toolsByCategory = {};
            availableTools.forEach(t => {
              if (!toolsByCategory[t.category]) toolsByCategory[t.category] = [];
              toolsByCategory[t.category].push(t);
            });
            const sortedCategories = Object.keys(toolsByCategory).sort();
          %>
          <% sortedCategories.forEach(category => { %>
            <div class="tool-category-header"><%= category %></div>
            <div class="tool-selection-grid">
              <% toolsByCategory[category].forEach(tool => {
                const isSelected = selectedCustomAgent.tools.includes(tool.name);
              %>
                <label
                  class="tool-checkbox<%= isSelected ? ' selected' : '' %>"
                  data-tool="<%= tool.name %>"
                  title="<%= tool.description %>"
                >
                  <input type="checkbox" <%= isSelected ? 'checked' : '' %> onchange="toggleToolSelection(this)">
                  <span><%= tool.name %></span>
                </label>
              <% }) %>
            </div>
          <% }) %>
        </div>

        <% if (availableKbs.length > 0) { %>
        <div class="form-group">
          <label>Knowledge Bases</label>
          <div class="kb-selection">
            <% availableKbs.forEach(kb => {
              const isSelected = selectedCustomAgent.knowledgeBases.includes(kb.id);
            %>
              <label
                class="kb-checkbox<%= isSelected ? ' selected' : '' %>"
                data-kb="<%= kb.id %>"
                title="<%= kb.description %>"
              >
                <input type="checkbox" <%= isSelected ? 'checked' : '' %> onchange="toggleKbSelection(this)">
                <span><%= kb.name %></span>
              </label>
            <% }) %>
          </div>
        </div>
        <% } %>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Save Changes</button>
          <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="deleteAgent()">Delete</button>
        </div>
      </form>
    <% } %>
  </main>
</div>

<script>
  // Store data for client-side operations
  const agentData = <%- JSON.stringify(experiments) %>;
  const customAgentData = <%- JSON.stringify(customAgents) %>;
  const availableToolsData = <%- JSON.stringify(availableTools) %>;
  const availableModelsData = <%- JSON.stringify(availableModels) %>;
  const availableKbsData = <%- JSON.stringify(availableKbs) %>;

  let currentTab = '<%= tab %>';
  let currentAgentId = '<%= selectedAgent ? selectedAgent.id : "" %>';
  let currentCustomAgentId = '<%= selectedCustomAgent ? selectedCustomAgent.id : "" %>';
  let currentEditMode = <%= editMode ? 'true' : 'false' %>;

  // Sidebar toggle for mobile
  const sidebarToggle = document.getElementById('sidebarToggle');
  const sidebar = document.getElementById('agentsSidebar');
  const overlay = document.getElementById('sidebarOverlay');

  function toggleSidebar() {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('open');
  }

  if (sidebarToggle) {
    sidebarToggle.addEventListener('click', toggleSidebar);
  }
  if (overlay) {
    overlay.addEventListener('click', toggleSidebar);
  }

  function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.agents-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.agents-tab:nth-child(${tab === 'builtin' ? 1 : 2})`).classList.add('active');

    document.getElementById('builtinAgents').style.display = tab === 'builtin' ? '' : 'none';
    document.getElementById('customAgents').style.display = tab === 'custom' ? '' : 'none';

    history.pushState({}, '', '/agents?tab=' + tab);

    // Show appropriate empty state
    const main = document.getElementById('agentsMain');
    if (tab === 'builtin' && !currentAgentId) {
      main.innerHTML = '<div class="empty-state"><p>Select an agent to view details</p></div>';
    } else if (tab === 'custom' && !currentCustomAgentId) {
      main.innerHTML = `
        <div class="empty-state">
          <h2>Custom Agents</h2>
          <p>Create your own agent with a custom system prompt and selected tools.</p>
          <button class="btn btn-primary" onclick="createNewAgent()">Create Agent</button>
        </div>
      `;
    }
  }

  function toggleGroup(header) {
    const group = header.closest('.agent-group');
    group.classList.toggle('collapsed');
    const icon = header.querySelector('.agent-group-icon');
    icon.innerHTML = group.classList.contains('collapsed') ? '&#9654;' : '&#9660;';
  }

  function toggleSection(header) {
    const section = header.closest('.agent-section');
    section.classList.toggle('collapsed');
    const icon = header.querySelector('.agent-section-icon');
    icon.innerHTML = section.classList.contains('collapsed') ? '&#9654;' : '&#9660;';
  }

  // Built-in agent selection
  async function selectAgent(id) {
    if (id === currentAgentId) return;

    sidebar.classList.remove('open');
    overlay.classList.remove('open');

    history.pushState({}, '', '/agents?tab=builtin&id=' + encodeURIComponent(id));

    document.querySelectorAll('.agent-item').forEach(item => {
      item.classList.toggle('active', item.dataset.id === id);
    });

    const agent = agentData.find(a => a.id === id);
    if (agent) {
      currentAgentId = id;

      let conversations = [];
      try {
        const res = await fetch('/api/conversations/by-agent/' + encodeURIComponent(id) + '?limit=5');
        const data = await res.json();
        conversations = data.data || [];
      } catch (e) {
        console.error('Failed to fetch conversations:', e);
      }

      renderBuiltinAgentDetail(agent, conversations);
    }
  }

  // Custom agent selection
  async function selectCustomAgent(id, editMode = false) {
    sidebar.classList.remove('open');
    overlay.classList.remove('open');

    const urlParams = '/agents?tab=custom&id=custom:' + encodeURIComponent(id) + (editMode ? '&edit=true' : '');
    history.pushState({}, '', urlParams);

    document.querySelectorAll('.custom-agent-item').forEach(item => {
      item.classList.toggle('active', item.dataset.id === id);
    });

    const agent = customAgentData.find(a => a.id === id);
    if (agent) {
      currentCustomAgentId = id;
      currentEditMode = editMode;

      if (editMode) {
        renderCustomAgentEditor(agent);
      } else {
        // Fetch recent conversations
        let conversations = [];
        try {
          const res = await fetch('/api/conversations/by-agent/custom:' + encodeURIComponent(id) + '?limit=5');
          const data = await res.json();
          conversations = data.data || [];
        } catch (e) {
          console.error('Failed to fetch conversations:', e);
        }
        renderCustomAgentView(agent, conversations);
      }
    }
  }

  function editCustomAgent() {
    if (currentCustomAgentId) {
      selectCustomAgent(currentCustomAgentId, true);
    }
  }

  function cancelEdit() {
    if (currentCustomAgentId) {
      selectCustomAgent(currentCustomAgentId, false);
    }
  }

  function createNewAgent() {
    // Create a new agent via API with defaults
    fetch('/api/custom-agents', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: 'New Agent',
        description: '',
        systemPrompt: 'You are a helpful assistant.',
        tools: [],
        knowledgeBases: [],
        model: availableModelsData[0]?.id || 'x-ai/grok-3-fast',
        temperature: 0.7,
        maxTokens: 8192
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.data) {
        window.location.href = '/agents?tab=custom&id=custom:' + data.data.id;
      } else {
        alert(data.error || 'Failed to create agent');
      }
    })
    .catch(err => alert('Failed to create agent: ' + err.message));
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function renderBuiltinAgentDetail(agent, conversations = []) {
    const main = document.getElementById('agentsMain');

    const conversationsHtml = conversations.length > 0
      ? conversations.map(conv => `
          <a href="/?id=${conv.id}" class="conversation-item-compact">
            <span class="conversation-title">${escapeHtml(conv.title || 'Untitled conversation')}</span>
            <span class="conversation-date">${new Date(conv.updatedAt).toLocaleDateString()}</span>
          </a>
        `).join('')
      : '<p class="text-muted">No conversations yet</p>';

    const kbHtml = agent.knowledgeBases.length > 0 ? `
      <div class="agent-section">
        <div class="agent-section-header" onclick="toggleSection(this)">
          <span class="agent-section-icon">&#9660;</span>
          <h3>Knowledge Bases (${agent.knowledgeBases.length})</h3>
        </div>
        <div class="agent-section-content">
          <div class="kb-list">
            ${agent.knowledgeBases.map(kb => `<span class="badge badge-outline">${escapeHtml(kb)}</span>`).join('')}
          </div>
        </div>
      </div>
    ` : '';

    const toolsHtml = agent.tools.map(tool => `
      <div class="tool-card">
        <div class="tool-card-name">${escapeHtml(tool.name)}</div>
        <div class="tool-card-description">${escapeHtml(tool.description)}</div>
      </div>
    `).join('');

    const tempHtml = agent.temperature !== undefined ? `
      <div class="agent-meta-item">
        <span class="agent-meta-label">Temperature</span>
        <span class="agent-meta-value">${agent.temperature}</span>
      </div>` : '';

    const maxTokensHtml = agent.maxTokens !== undefined ? `
      <div class="agent-meta-item">
        <span class="agent-meta-label">Max Tokens</span>
        <span class="agent-meta-value">${agent.maxTokens.toLocaleString()}</span>
      </div>` : '';

    main.innerHTML = `
      <div class="agent-detail" id="agentDetail">
        <div class="agent-detail-header">
          <div class="agent-detail-title">
            <span class="agent-type-badge">${escapeHtml(agent.type)}</span>
            <h1>${escapeHtml(agent.experiment)}</h1>
          </div>
          <a href="/new?agent=${encodeURIComponent(agent.id)}" class="btn btn-primary">Start Chat</a>
        </div>

        <p class="agent-description">${escapeHtml(agent.description)}</p>

        <div class="agent-meta-grid">
          <div class="agent-meta-item">
            <span class="agent-meta-label">Model</span>
            <span class="agent-meta-value">${escapeHtml(agent.model)}</span>
          </div>
          ${tempHtml}
          ${maxTokensHtml}
          <div class="agent-meta-item">
            <span class="agent-meta-label">Tools</span>
            <span class="agent-meta-value">${agent.toolCount}</span>
          </div>
        </div>

        <div class="agent-section">
          <div class="agent-section-header" onclick="toggleSection(this)">
            <span class="agent-section-icon">&#9660;</span>
            <h3>Recent Conversations (${conversations.length})</h3>
          </div>
          <div class="agent-section-content">
            <div class="conversation-list-compact">${conversationsHtml}</div>
          </div>
        </div>

        ${kbHtml}

        <div class="agent-section">
          <div class="agent-section-header" onclick="toggleSection(this)">
            <span class="agent-section-icon">&#9660;</span>
            <h3>Available Tools (${agent.tools.length})</h3>
          </div>
          <div class="agent-section-content">
            <div class="tools-grid">${toolsHtml}</div>
          </div>
        </div>

        <div class="agent-section">
          <div class="agent-section-header" onclick="toggleSection(this)">
            <span class="agent-section-icon">&#9660;</span>
            <h3>System Prompt</h3>
          </div>
          <div class="agent-section-content">
            <div class="system-prompt-container">
              <pre class="system-prompt-preview" id="promptPreview">${escapeHtml(agent.systemPromptPreview)}</pre>
              <pre class="system-prompt-full hidden" id="promptFull">${escapeHtml(agent.systemPromptFull)}</pre>
            </div>
            <button class="btn btn-small btn-secondary" onclick="toggleSystemPrompt(event)" style="margin-top: 0.5rem;">
              <span id="togglePromptText">Show Full</span>
            </button>
          </div>
        </div>
      </div>
    `;
  }

  function renderCustomAgentView(agent, conversations = []) {
    const main = document.getElementById('agentsMain');

    const conversationsHtml = conversations.length > 0
      ? conversations.map(conv => `
          <a href="/?id=${conv.id}" class="conversation-item-compact">
            <span class="conversation-title">${escapeHtml(conv.title || 'Untitled conversation')}</span>
            <span class="conversation-date">${new Date(conv.updatedAt).toLocaleDateString()}</span>
          </a>
        `).join('')
      : '<p class="text-muted">No conversations yet</p>';

    const kbHtml = agent.knowledgeBases.length > 0 ? `
      <div class="agent-section">
        <div class="agent-section-header" onclick="toggleSection(this)">
          <span class="agent-section-icon">&#9660;</span>
          <h3>Knowledge Bases (${agent.knowledgeBases.length})</h3>
        </div>
        <div class="agent-section-content">
          <div class="kb-list">
            ${agent.knowledgeBases.map(kb => `<span class="badge badge-outline">${escapeHtml(kb)}</span>`).join('')}
          </div>
        </div>
      </div>
    ` : '';

    // Get tool descriptions from availableToolsData
    const toolsHtml = agent.tools.map(toolName => {
      const toolData = availableToolsData.find(t => t.name === toolName);
      return `
        <div class="tool-card">
          <div class="tool-card-name">${escapeHtml(toolName)}</div>
          <div class="tool-card-description">${escapeHtml(toolData?.description || '')}</div>
        </div>
      `;
    }).join('');

    const promptPreview = agent.systemPrompt.substring(0, 500) + (agent.systemPrompt.length > 500 ? '...' : '');

    main.innerHTML = `
      <div class="agent-detail" id="agentDetail">
        <div class="agent-detail-header">
          <div class="agent-detail-title">
            <span class="agent-type-badge">Custom</span>
            <h1>${escapeHtml(agent.name)}</h1>
          </div>
          <div class="agent-detail-actions">
            <button class="btn btn-secondary" onclick="editCustomAgent()">Edit</button>
            <button class="btn btn-primary" onclick="startChatWithCustomAgent('${agent.id}')">Start Chat</button>
          </div>
        </div>

        <p class="agent-description">${escapeHtml(agent.description || 'No description')}</p>

        <div class="agent-meta-grid">
          <div class="agent-meta-item">
            <span class="agent-meta-label">Model</span>
            <span class="agent-meta-value">${escapeHtml(agent.model)}</span>
          </div>
          <div class="agent-meta-item">
            <span class="agent-meta-label">Temperature</span>
            <span class="agent-meta-value">${agent.temperature}</span>
          </div>
          <div class="agent-meta-item">
            <span class="agent-meta-label">Max Tokens</span>
            <span class="agent-meta-value">${agent.maxTokens.toLocaleString()}</span>
          </div>
          <div class="agent-meta-item">
            <span class="agent-meta-label">Tools</span>
            <span class="agent-meta-value">${agent.tools.length}</span>
          </div>
        </div>

        <div class="agent-section">
          <div class="agent-section-header" onclick="toggleSection(this)">
            <span class="agent-section-icon">&#9660;</span>
            <h3>Recent Conversations (${conversations.length})</h3>
          </div>
          <div class="agent-section-content">
            <div class="conversation-list-compact">${conversationsHtml}</div>
          </div>
        </div>

        ${kbHtml}

        <div class="agent-section">
          <div class="agent-section-header" onclick="toggleSection(this)">
            <span class="agent-section-icon">&#9660;</span>
            <h3>Available Tools (${agent.tools.length})</h3>
          </div>
          <div class="agent-section-content">
            <div class="tools-grid">${toolsHtml}</div>
          </div>
        </div>

        <div class="agent-section">
          <div class="agent-section-header" onclick="toggleSection(this)">
            <span class="agent-section-icon">&#9660;</span>
            <h3>System Prompt</h3>
          </div>
          <div class="agent-section-content">
            <div class="system-prompt-container">
              <pre class="system-prompt-preview" id="promptPreview">${escapeHtml(promptPreview)}</pre>
              <pre class="system-prompt-full hidden" id="promptFull">${escapeHtml(agent.systemPrompt)}</pre>
            </div>
            <button class="btn btn-small btn-secondary" onclick="toggleSystemPrompt(event)" style="margin-top: 0.5rem;">
              <span id="togglePromptText">Show Full</span>
            </button>
          </div>
        </div>
      </div>
    `;
  }

  function renderCustomAgentEditor(agent) {
    const main = document.getElementById('agentsMain');

    // Group tools by category
    const toolsByCategory = {};
    availableToolsData.forEach(t => {
      if (!toolsByCategory[t.category]) toolsByCategory[t.category] = [];
      toolsByCategory[t.category].push(t);
    });
    const sortedCategories = Object.keys(toolsByCategory).sort();

    const isCustomModel = !availableModelsData.some(m => m.id === agent.model);

    const modelOptions = availableModelsData.map(m =>
      `<option value="${m.id}" ${agent.model === m.id ? 'selected' : ''}>${escapeHtml(m.name)}</option>`
    ).join('') + `<option value="custom" ${isCustomModel ? 'selected' : ''}>Custom...</option>`;

    const toolsHtml = sortedCategories.map(category => {
      const tools = toolsByCategory[category].map(tool => {
        const isSelected = agent.tools.includes(tool.name);
        return `
          <label class="tool-checkbox${isSelected ? ' selected' : ''}" data-tool="${tool.name}" title="${escapeHtml(tool.description)}">
            <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleToolSelection(this)">
            <span>${escapeHtml(tool.name)}</span>
          </label>
        `;
      }).join('');
      return `<div class="tool-category-header">${category}</div><div class="tool-selection-grid">${tools}</div>`;
    }).join('');

    const kbsHtml = availableKbsData.length > 0 ? `
      <div class="form-group">
        <label>Knowledge Bases</label>
        <div class="kb-selection">
          ${availableKbsData.map(kb => {
            const isSelected = agent.knowledgeBases.includes(kb.id);
            return `
              <label class="kb-checkbox${isSelected ? ' selected' : ''}" data-kb="${kb.id}" title="${escapeHtml(kb.description)}">
                <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleKbSelection(this)">
                <span>${escapeHtml(kb.name)}</span>
              </label>
            `;
          }).join('')}
        </div>
      </div>
    ` : '';

    main.innerHTML = `
      <form class="agent-form" id="agentForm" onsubmit="saveAgent(event)">
        <input type="hidden" id="agentId" value="${agent.id}">

        <div class="form-group">
          <label for="name">Name</label>
          <input type="text" id="name" class="form-control" value="${escapeHtml(agent.name)}" required maxlength="100">
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" class="form-control" rows="2">${escapeHtml(agent.description || '')}</textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="model">Model</label>
            <select id="model" class="form-control" onchange="toggleCustomModel()">
              ${modelOptions}
            </select>
            <input type="text" id="customModel" class="form-control model-custom-input${isCustomModel ? '' : ' hidden'}" placeholder="Enter OpenRouter model ID" value="${isCustomModel ? escapeHtml(agent.model) : ''}">
          </div>
          <div class="form-group">
            <label for="temperature">Temperature</label>
            <input type="number" id="temperature" class="form-control" value="${agent.temperature}" min="0" max="2" step="0.1">
          </div>
          <div class="form-group">
            <label for="maxTokens">Max Tokens</label>
            <input type="number" id="maxTokens" class="form-control" value="${agent.maxTokens}" min="100" max="128000">
          </div>
        </div>

        <div class="form-group">
          <label for="systemPrompt">System Prompt</label>
          <textarea id="systemPrompt" class="form-control system-prompt-editor" required>${escapeHtml(agent.systemPrompt)}</textarea>
        </div>

        <div class="form-group">
          <label>Tools (<span id="toolCount">${agent.tools.length}</span> selected)</label>
          ${toolsHtml}
        </div>

        ${kbsHtml}

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Save Changes</button>
          <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="deleteAgent()">Delete</button>
        </div>
      </form>
    `;
  }

  function toggleCustomModel() {
    const select = document.getElementById('model');
    const customInput = document.getElementById('customModel');
    if (select.value === 'custom') {
      customInput.classList.remove('hidden');
      customInput.focus();
    } else {
      customInput.classList.add('hidden');
    }
  }

  function toggleToolSelection(checkbox) {
    const label = checkbox.closest('.tool-checkbox');
    label.classList.toggle('selected', checkbox.checked);
    updateToolCount();
  }

  function toggleKbSelection(checkbox) {
    const label = checkbox.closest('.kb-checkbox');
    label.classList.toggle('selected', checkbox.checked);
  }

  function updateToolCount() {
    const count = document.querySelectorAll('.tool-checkbox.selected').length;
    const countEl = document.getElementById('toolCount');
    if (countEl) countEl.textContent = count;
  }

  async function saveAgent(e) {
    e.preventDefault();

    const id = document.getElementById('agentId').value;
    const modelSelect = document.getElementById('model');
    const customModel = document.getElementById('customModel');
    const model = modelSelect.value === 'custom' ? customModel.value : modelSelect.value;

    const tools = Array.from(document.querySelectorAll('.tool-checkbox.selected'))
      .map(el => el.dataset.tool);
    const kbs = Array.from(document.querySelectorAll('.kb-checkbox.selected'))
      .map(el => el.dataset.kb);

    const data = {
      name: document.getElementById('name').value,
      description: document.getElementById('description').value,
      model,
      temperature: parseFloat(document.getElementById('temperature').value),
      maxTokens: parseInt(document.getElementById('maxTokens').value),
      systemPrompt: document.getElementById('systemPrompt').value,
      tools,
      knowledgeBases: kbs,
    };

    try {
      const res = await fetch('/api/custom-agents/' + id, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      if (res.ok) {
        // Update local data
        const idx = customAgentData.findIndex(a => a.id === id);
        if (idx !== -1) customAgentData[idx] = result.data;

        // Update sidebar name if changed
        const sidebarItem = document.querySelector(`.custom-agent-item[data-id="${id}"]`);
        if (sidebarItem) {
          sidebarItem.querySelector('.custom-agent-name').textContent = result.data.name;
          sidebarItem.querySelector('.custom-agent-model').textContent = result.data.model.split('/').pop();
        }

        alert('Agent saved successfully');
      } else {
        alert(result.error || 'Failed to save agent');
      }
    } catch (err) {
      alert('Failed to save agent: ' + err.message);
    }
  }

  async function deleteAgent() {
    if (!confirm('Delete this agent? This cannot be undone.')) return;

    const id = document.getElementById('agentId').value;

    try {
      const res = await fetch('/api/custom-agents/' + id, { method: 'DELETE' });
      if (res.ok) {
        window.location.href = '/agents?tab=custom';
      } else {
        const result = await res.json();
        alert(result.error || 'Failed to delete agent');
      }
    } catch (err) {
      alert('Failed to delete agent: ' + err.message);
    }
  }

  function startChatWithCustomAgent(agentId) {
    // Use passed id or fall back to form input (for edit mode)
    const id = agentId || document.getElementById('agentId')?.value || currentCustomAgentId;
    if (!id) return;

    fetch('/api/conversations', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agentId: 'custom:' + id })
    })
    .then(r => r.json())
    .then(data => {
      if (data.data?.id) {
        window.location.href = '/?id=' + data.data.id;
      } else {
        alert(data.error || 'Failed to start conversation');
      }
    })
    .catch(err => alert('Failed to start conversation: ' + err.message));
  }

  function toggleSystemPrompt(event) {
    if (event) event.stopPropagation();
    const preview = document.getElementById('promptPreview');
    const full = document.getElementById('promptFull');
    const toggleText = document.getElementById('togglePromptText');

    preview.classList.toggle('hidden');
    full.classList.toggle('hidden');
    toggleText.textContent = full.classList.contains('hidden') ? 'Show Full' : 'Show Preview';
  }

  // Handle browser back/forward
  window.addEventListener('popstate', () => {
    const params = new URLSearchParams(window.location.search);
    const tab = params.get('tab') || 'builtin';
    const id = params.get('id');
    const editMode = params.get('edit') === 'true';

    if (tab !== currentTab) {
      switchTab(tab);
    }

    if (id) {
      if (id.startsWith('custom:')) {
        selectCustomAgent(id.replace('custom:', ''), editMode);
      } else {
        selectAgent(id);
      }
    }
  });
</script>

<%- include('partials/footer') %>
