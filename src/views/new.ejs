<%- include('partials/header') %>

<div class="page">
  <h1>New Conversation</h1>

  <form class="form" id="newConversationForm">
    <div class="form-group">
      <label for="agentId">Select Agent</label>
      <select name="agentId" id="agentId" class="form-control" required>
        <% agents.forEach(agent => { %>
          <option value="<%= agent.id %>"><%= agent.id %> (v<%= agent.defaultVersion %>)</option>
        <% }) %>
      </select>
    </div>

    <div class="form-group">
      <label for="initialMessage">Initial Message (optional)</label>
      <textarea
        name="initialMessage"
        id="initialMessage"
        class="form-control"
        rows="4"
        placeholder="Start your conversation..."
      ></textarea>
    </div>

    <div class="form-actions">
      <a href="/conversations" class="btn btn-secondary">Cancel</a>
      <button type="submit" class="btn btn-primary">Create Conversation</button>
    </div>
  </form>
</div>

<script>
  document.getElementById('newConversationForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    const response = await fetch('/api/conversations', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        agentId: formData.get('agentId'),
        initialMessage: formData.get('initialMessage') || undefined
      })
    });

    const data = await response.json();
    if (data.data && data.data.id) {
      window.location.href = '/conversations/' + data.data.id;
    }
  });
</script>

<%- include('partials/footer') %>
