<%- include('partials/header') %>

<style>
  /* Override container for full-width chat layout */
  main.container {
    max-width: none;
    padding: 0;
    margin: 0;
    width: 100%;
  }
</style>

<div class="chat-layout">
  <!-- Mobile sidebar toggle -->
  <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
    <span class="hamburger-icon">&#9776;</span>
  </button>

  <!-- Overlay for mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar -->
  <aside class="chat-sidebar" id="chatSidebar">
    <div class="sidebar-header">
      <h2>Conversations</h2>
    </div>
    <div class="new-conversation-form">
      <select id="agentSelect" class="form-control">
        <% experiments.forEach(exp => { %>
          <option value="<%= exp.id %>"><%= exp.id %></option>
        <% }) %>
      </select>
      <button type="button" onclick="createConversation()" class="btn btn-primary btn-small">+ New</button>
    </div>
    <div class="conversation-list" id="conversationList">
      <% if (conversations.length === 0) { %>
        <div class="empty-state">
          <p>No conversations yet</p>
        </div>
      <% } else { %>
        <% conversations.forEach(conv => { %>
          <div
            class="conversation-row<%= selectedConversation && selectedConversation.id === conv.id ? ' active' : '' %>"
            data-id="<%= conv.id %>"
            onclick="selectConversation('<%= conv.id %>')"
          >
            <div class="conversation-info">
              <span class="experiment-id"><%= conv.agentId %>/<%= conv.agentVersion %></span>
              <span class="conversation-title"><%= conv.title || 'Untitled conversation' %></span>
            </div>
            <span class="conversation-date text-muted"><%= new Date(conv.createdAt).toLocaleDateString() %></span>
          </div>
        <% }) %>
      <% } %>
    </div>
  </aside>

  <!-- Main chat area -->
  <main class="chat-main" id="chatMain">
    <% if (!selectedConversation) { %>
      <div class="empty-state" id="emptyState">
        <p>Select a conversation or create a new one</p>
      </div>
    <% } else { %>
      <div class="chat-content" id="chatContent">
        <div class="chat-header">
          <div>
            <h1 id="chatTitle"><%= selectedConversation.title || 'Chat' %></h1>
            <div class="chat-meta">
              <span class="experiment-id" id="chatAgentId"><%= selectedConversation.agentId %>/<%= selectedConversation.agentVersion %></span>
              <span class="text-muted">&#8226;</span>
              <span class="text-muted" id="chatDate"><%= new Date(selectedConversation.createdAt).toLocaleString() %></span>
            </div>
          </div>
        </div>

        <div class="chat-messages" id="messages">
          <%
            // Group consecutive assistant messages, preserving chronological order via parts array
            const groupedMessages = [];
            for (const msg of messages) {
              const last = groupedMessages[groupedMessages.length - 1];

              // Build parts for this message (tools first, then content)
              const msgParts = [];
              if (msg.toolExecutions?.length > 0) {
                msgParts.push({ type: 'tools', tools: msg.toolExecutions });
              }
              if (msg.content) {
                msgParts.push({ type: 'content', text: msg.content });
              }

              if (msg.role === 'assistant' && last?.role === 'assistant') {
                // Append parts to existing group
                last.parts.push(...msgParts);
              } else {
                groupedMessages.push({ role: msg.role, parts: msgParts });
              }
            }
          %>
          <% if (groupedMessages.length === 0) { %>
            <div class="empty-state">
              <p>No messages yet. Start the conversation below.</p>
            </div>
          <% } else { %>
            <% groupedMessages.forEach(msg => { %>
              <div class="message message-<%= msg.role %>">
                <div class="message-header">
                  <span class="message-role"><%= msg.role %></span>
                </div>
                <% msg.parts.forEach(part => { %>
                  <% if (part.type === 'tools') { %>
                    <div class="tool-executions">
                      <% part.tools.forEach(tool => {
                        const summary = tool.input.name || tool.input.id || tool.input.moduleId || '';
                      %>
                        <div class="tool-execution" data-tool-id="<%= tool.id %>">
                          <div class="tool-pill" onclick="toggleToolExecution(this)">
                            <span class="tool-pill-icon">&#9654;</span>
                            <span class="tool-pill-name"><%= tool.name %><% if (summary) { %>("<%= summary %>")<% } %></span>
                            <span class="tool-pill-duration"><%= tool.durationMs %>ms</span>
                            <span class="tool-pill-status <%= tool.result.success ? 'success' : 'error' %>"><%= tool.result.success ? '&#10003;' : '&#10007;' %></span>
                          </div>
                          <div class="tool-details">
                            <pre class="tool-json"><%= JSON.stringify(tool.input) %> &rarr; <%= tool.result.error ? tool.result.error : JSON.stringify(tool.result.output) %></pre>
                          </div>
                        </div>
                      <% }) %>
                    </div>
                  <% } else { %>
                    <div class="message-content"><%= part.text %></div>
                  <% } %>
                <% }) %>
              </div>
            <% }) %>
          <% } %>
        </div>

        <form class="chat-input" id="chatForm">
          <input type="hidden" name="conversationId" id="conversationIdInput" value="<%= selectedConversation.id %>">
          <textarea
            name="content"
            id="messageInput"
            placeholder="Type your message..."
            rows="2"
            required
          ></textarea>
          <button type="submit" class="btn btn-primary">Send</button>
        </form>
      </div>
    <% } %>
  </main>
</div>

<script>
  let currentConversationId = '<%= selectedConversation ? selectedConversation.id : "" %>';
  const pendingTools = new Map();

  // Sidebar toggle for mobile
  const sidebarToggle = document.getElementById('sidebarToggle');
  const sidebar = document.getElementById('chatSidebar');
  const overlay = document.getElementById('sidebarOverlay');

  function toggleSidebar() {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('open');
  }

  sidebarToggle.addEventListener('click', toggleSidebar);
  overlay.addEventListener('click', toggleSidebar);

  function toggleToolExecution(pill) {
    pill.parentElement.classList.toggle('expanded');
    const icon = pill.querySelector('.tool-pill-icon');
    if (icon) icon.innerHTML = pill.parentElement.classList.contains('expanded') ? '&#9660;' : '&#9654;';
  }

  function getToolSummary(input) {
    return input.name || input.id || input.moduleId || '';
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async function createConversation() {
    const agentSelect = document.getElementById('agentSelect');
    const agentId = agentSelect.value;

    const response = await fetch('/api/conversations', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agentId })
    });

    const data = await response.json();
    if (data.data?.id) {
      addConversationToSidebar(data.data);
      selectConversation(data.data.id);
    }
  }

  function addConversationToSidebar(conv) {
    const list = document.getElementById('conversationList');

    // Remove empty state if present
    const emptyState = list.querySelector('.empty-state');
    if (emptyState) emptyState.remove();

    // Create new conversation row
    const row = document.createElement('div');
    row.className = 'conversation-row';
    row.dataset.id = conv.id;
    row.onclick = () => selectConversation(conv.id);
    row.innerHTML = `
      <div class="conversation-info">
        <span class="experiment-id">${escapeHtml(conv.agentId)}/${escapeHtml(conv.agentVersion)}</span>
        <span class="conversation-title">${escapeHtml(conv.title || 'Untitled conversation')}</span>
      </div>
      <span class="conversation-date text-muted">${new Date(conv.createdAt).toLocaleDateString()}</span>
    `;

    // Insert at top of list
    list.insertBefore(row, list.firstChild);
  }

  async function selectConversation(id) {
    if (id === currentConversationId) return;

    // Close mobile sidebar
    sidebar.classList.remove('open');
    overlay.classList.remove('open');

    // Update URL without reload
    history.pushState({}, '', '/conversations?id=' + id);

    // Update active state in sidebar
    document.querySelectorAll('.conversation-row').forEach(row => {
      row.classList.toggle('active', row.dataset.id === id);
    });

    // Fetch conversation + messages
    const [convRes, msgsRes] = await Promise.all([
      fetch('/api/conversations/' + id),
      fetch('/api/conversations/' + id + '/messages')
    ]);

    const conv = await convRes.json();
    const msgs = await msgsRes.json();

    if (conv.data && msgs.data) {
      currentConversationId = id;
      renderConversation(conv.data, msgs.data);
    }
  }

  function renderConversation(conv, messages) {
    const chatMain = document.getElementById('chatMain');

    // Group messages
    const groupedMessages = [];
    for (const msg of messages) {
      const last = groupedMessages[groupedMessages.length - 1];
      const msgParts = [];
      if (msg.toolExecutions?.length > 0) {
        msgParts.push({ type: 'tools', tools: msg.toolExecutions });
      }
      if (msg.content) {
        msgParts.push({ type: 'content', text: msg.content });
      }
      if (msg.role === 'assistant' && last?.role === 'assistant') {
        last.parts.push(...msgParts);
      } else {
        groupedMessages.push({ role: msg.role, parts: msgParts });
      }
    }

    // Build messages HTML
    let messagesHtml = '';
    if (groupedMessages.length === 0) {
      messagesHtml = '<div class="empty-state"><p>No messages yet. Start the conversation below.</p></div>';
    } else {
      groupedMessages.forEach(msg => {
        messagesHtml += '<div class="message message-' + msg.role + '">';
        messagesHtml += '<div class="message-header"><span class="message-role">' + msg.role + '</span></div>';
        msg.parts.forEach(part => {
          if (part.type === 'tools') {
            messagesHtml += '<div class="tool-executions">';
            part.tools.forEach(tool => {
              const summary = getToolSummary(tool.input);
              messagesHtml += '<div class="tool-execution" data-tool-id="' + tool.id + '">';
              messagesHtml += '<div class="tool-pill" onclick="toggleToolExecution(this)">';
              messagesHtml += '<span class="tool-pill-icon">&#9654;</span>';
              messagesHtml += '<span class="tool-pill-name">' + escapeHtml(tool.name) + (summary ? '("' + escapeHtml(summary) + '")' : '') + '</span>';
              messagesHtml += '<span class="tool-pill-duration">' + tool.durationMs + 'ms</span>';
              messagesHtml += '<span class="tool-pill-status ' + (tool.result.success ? 'success' : 'error') + '">' + (tool.result.success ? '&#10003;' : '&#10007;') + '</span>';
              messagesHtml += '</div>';
              messagesHtml += '<div class="tool-details"><pre class="tool-json">' + escapeHtml(JSON.stringify(tool.input)) + ' &rarr; ' + escapeHtml(tool.result.error || JSON.stringify(tool.result.output)) + '</pre></div>';
              messagesHtml += '</div>';
            });
            messagesHtml += '</div>';
          } else {
            messagesHtml += '<div class="message-content">' + escapeHtml(part.text) + '</div>';
          }
        });
        messagesHtml += '</div>';
      });
    }

    chatMain.innerHTML = `
      <div class="chat-content" id="chatContent">
        <div class="chat-header">
          <div>
            <h1 id="chatTitle">${escapeHtml(conv.title || 'Chat')}</h1>
            <div class="chat-meta">
              <span class="experiment-id" id="chatAgentId">${escapeHtml(conv.agentId)}/${escapeHtml(conv.agentVersion)}</span>
              <span class="text-muted">&#8226;</span>
              <span class="text-muted" id="chatDate">${new Date(conv.createdAt).toLocaleString()}</span>
            </div>
          </div>
        </div>
        <div class="chat-messages" id="messages">${messagesHtml}</div>
        <form class="chat-input" id="chatForm">
          <input type="hidden" name="conversationId" id="conversationIdInput" value="${conv.id}">
          <textarea name="content" id="messageInput" placeholder="Type your message..." rows="2" required></textarea>
          <button type="submit" class="btn btn-primary">Send</button>
        </form>
      </div>
    `;

    // Re-attach form listener
    document.getElementById('chatForm').addEventListener('submit', handleSubmit);

    // Scroll to bottom
    const messagesContainer = document.getElementById('messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  async function handleSubmit(e) {
    e.preventDefault();
    const input = document.getElementById('messageInput');
    const messagesContainer = document.getElementById('messages');
    const content = input.value.trim();
    if (!content) return;

    // Add user message to UI
    addMessage('user', content);
    input.value = '';

    // Create assistant message placeholder
    const assistantMsg = addMessage('assistant', '');
    pendingTools.clear();

    // Send to API with SSE
    const response = await fetch('/api/conversations/' + currentConversationId + '/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          try {
            const data = JSON.parse(line.slice(6));
            if (data.type === 'text') {
              assistantMsg.querySelector('.message-content').textContent += data.content;
            } else if (data.type === 'tool_use') {
              addPendingToolExecution(assistantMsg, data.id, data.name, data.input);
            } else if (data.type === 'tool_result') {
              updateToolExecutionResult(assistantMsg, data.id, data.name, data.result, data.durationMs);
            } else if (data.type === 'error' || data.error) {
              assistantMsg.classList.add('message-error');
              assistantMsg.querySelector('.message-content').textContent =
                'Error: ' + (data.error || data.message || 'Unknown error');
            }
          } catch (e) {}
        }
      }
    }

    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function addMessage(role, content) {
    const messagesContainer = document.getElementById('messages');

    // Remove empty state if present
    const emptyState = messagesContainer.querySelector('.empty-state');
    if (emptyState) emptyState.remove();

    const div = document.createElement('div');
    div.className = 'message message-' + role;
    div.innerHTML =
      '<div class="message-header"><span class="message-role">' + role + '</span></div>' +
      '<div class="message-content">' + escapeHtml(content) + '</div>';
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    return div;
  }

  function addPendingToolExecution(msgEl, toolId, toolName, input) {
    let container = msgEl.querySelector('.tool-executions');
    if (!container) {
      container = document.createElement('div');
      container.className = 'tool-executions';
      msgEl.appendChild(container);
    }

    const summary = getToolSummary(input);
    const toolEl = document.createElement('div');
    toolEl.className = 'tool-execution';
    toolEl.dataset.toolId = toolId;
    toolEl.innerHTML = `
      <div class="tool-pill" onclick="toggleToolExecution(this)">
        <span class="tool-pill-icon">&#9654;</span>
        <span class="tool-pill-name">${escapeHtml(toolName)}${summary ? '("' + escapeHtml(summary) + '")' : ''}</span>
        <span class="tool-pill-duration">...</span>
        <span class="tool-pill-status pending">&#8987;</span>
      </div>
      <div class="tool-details">
        <pre class="tool-json">${escapeHtml(JSON.stringify(input))} &rarr; waiting...</pre>
      </div>
    `;
    container.appendChild(toolEl);
    pendingTools.set(toolId, { name: toolName, input });

    const messagesContainer = document.getElementById('messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function updateToolExecutionResult(msgEl, toolId, toolName, result, durationMs) {
    const toolEl = msgEl.querySelector('.tool-execution[data-tool-id="' + toolId + '"]');
    if (!toolEl) {
      addPendingToolExecution(msgEl, toolId, toolName, {});
      setTimeout(() => updateToolExecutionResult(msgEl, toolId, toolName, result, durationMs), 10);
      return;
    }

    const durationEl = toolEl.querySelector('.tool-pill-duration');
    if (durationEl) {
      durationEl.textContent = durationMs + 'ms';
    }

    const statusEl = toolEl.querySelector('.tool-pill-status');
    if (statusEl) {
      statusEl.className = 'tool-pill-status ' + (result.success ? 'success' : 'error');
      statusEl.innerHTML = result.success ? '&#10003;' : '&#10007;';
    }

    const pending = pendingTools.get(toolId);
    const inputJson = pending ? JSON.stringify(pending.input) : '{}';
    const outputJson = result.error ? result.error : JSON.stringify(result.output);
    const jsonEl = toolEl.querySelector('.tool-json');
    if (jsonEl) {
      jsonEl.textContent = inputJson + ' \u2192 ' + outputJson;
    }

    pendingTools.delete(toolId);
  }

  // Handle browser back/forward
  window.addEventListener('popstate', () => {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    if (id && id !== currentConversationId) {
      selectConversation(id);
    }
  });

  // Initialize form listener if conversation is selected
  const chatForm = document.getElementById('chatForm');
  if (chatForm) {
    chatForm.addEventListener('submit', handleSubmit);
  }

  // Scroll to bottom on load
  const messagesContainer = document.getElementById('messages');
  if (messagesContainer) {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
</script>

<%- include('partials/footer') %>
