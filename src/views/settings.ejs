<%- include('partials/header') %>

<div class="page">
  <h1>Settings</h1>

  <% if (typeof claudeAuthResult !== 'undefined' && claudeAuthResult) { %>
    <div class="alert <%= claudeAuthResult === 'success' ? 'alert-success' : 'alert-error' %>">
      <% if (claudeAuthResult === 'success') { %>
        Claude account connected successfully.
      <% } else { %>
        Failed to connect Claude: <%= typeof claudeAuthMessage !== 'undefined' ? claudeAuthMessage : 'Unknown error' %>
      <% } %>
    </div>
  <% } %>

  <div id="flash-message" class="alert" style="display: none;"></div>

  <div class="card">
    <div class="card-header">
      <h2>API Providers</h2>
      <p class="text-muted">Configure your API credentials to use the agent service.</p>
    </div>

    <div class="provider-list">
      <!-- OpenRouter -->
      <div class="provider-item">
        <div class="provider-header">
          <div class="provider-info">
            <h3>OpenRouter</h3>
            <p class="text-muted">Access multiple LLM models through OpenRouter's unified API.</p>
          </div>
          <div class="provider-status">
            <% if (providers.openrouter.connected) { %>
              <span class="badge badge-success">Connected</span>
            <% } else { %>
              <span class="badge badge-outline">Not connected</span>
            <% } %>
          </div>
        </div>

        <div class="provider-actions">
          <% if (providers.openrouter.connected) { %>
            <div class="form-inline">
              <input
                type="password"
                id="openrouter-key"
                class="form-control"
                placeholder="Enter new API key to update"
              />
              <button type="button" class="btn btn-secondary" onclick="saveOpenRouterKey()">Update</button>
              <button type="button" class="btn btn-danger-outline" onclick="removeOpenRouterKey()">Remove</button>
            </div>
          <% } else { %>
            <div class="form-inline">
              <input
                type="password"
                id="openrouter-key"
                class="form-control"
                placeholder="sk-or-v1-..."
              />
              <button type="button" class="btn btn-primary" onclick="saveOpenRouterKey()">Save Key</button>
            </div>
          <% } %>
          <p class="text-muted text-small">
            Get your API key from <a href="https://openrouter.ai/keys" target="_blank" rel="noopener">openrouter.ai/keys</a>
          </p>
        </div>
      </div>

      <hr class="provider-divider" />

      <!-- Claude -->
      <div class="provider-item">
        <div class="provider-header">
          <div class="provider-info">
            <h3>Claude</h3>
            <p class="text-muted">Use your Claude Pro or Max subscription via OAuth.</p>
          </div>
          <div class="provider-status">
            <% if (providers.claude.connected) { %>
              <span class="badge badge-success">Connected</span>
            <% } else { %>
              <span class="badge badge-outline">Not connected</span>
            <% } %>
          </div>
        </div>

        <div class="provider-actions">
          <% if (providers.claude.connected) { %>
            <button type="button" class="btn btn-danger-outline" onclick="disconnectClaude()">Disconnect</button>
          <% } else { %>
            <a href="/auth/claude" class="btn btn-primary">Connect with Claude</a>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function showFlash(message, type) {
    const flash = document.getElementById('flash-message');
    flash.textContent = message;
    flash.className = 'alert alert-' + type;
    flash.style.display = 'block';
    setTimeout(() => { flash.style.display = 'none'; }, 5000);
  }

  async function saveOpenRouterKey() {
    const input = document.getElementById('openrouter-key');
    const apiKey = input.value.trim();

    if (!apiKey) {
      showFlash('Please enter an API key', 'error');
      return;
    }

    try {
      const response = await fetch('/auth/openrouter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ apiKey })
      });

      if (response.ok) {
        location.reload();
      } else {
        const data = await response.json();
        showFlash(data.error || 'Failed to save API key', 'error');
      }
    } catch (err) {
      showFlash('Failed to save API key', 'error');
    }
  }

  async function removeOpenRouterKey() {
    if (!confirm('Are you sure you want to remove your OpenRouter API key?')) {
      return;
    }

    try {
      const response = await fetch('/auth/openrouter', { method: 'DELETE' });
      if (response.ok) {
        location.reload();
      } else {
        showFlash('Failed to remove API key', 'error');
      }
    } catch (err) {
      showFlash('Failed to remove API key', 'error');
    }
  }

  async function disconnectClaude() {
    if (!confirm('Are you sure you want to disconnect your Claude account?')) {
      return;
    }

    try {
      const response = await fetch('/auth/claude', { method: 'DELETE' });
      if (response.ok) {
        location.reload();
      } else {
        showFlash('Failed to disconnect Claude', 'error');
      }
    } catch (err) {
      showFlash('Failed to disconnect Claude', 'error');
    }
  }
</script>

<%- include('partials/footer') %>
